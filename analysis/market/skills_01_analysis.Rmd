---
title: "SHRS Market Analysis — Skills & Education Profiles"
author: "SHRS MQE Capstone Team"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo    = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 6
)
```

```{r packages}
library(tidyverse)
library(readxl)
library(janitor)
library(scales)
library(kableExtra)
```

# 0 — Configuration & Crosswalk

```{r config}
# ── EDIT THIS ONE LINE to match your machine ──
MARKET_ROOT <- file.path(path.expand("~"), "Documents", "SHRS_Analysis",
                          "market_analysis")

# Skills data paths
BLS_SKILLS_PATH <- file.path(MARKET_ROOT, "skills", "bls", "skills.xlsx")
ONET_SKILLS_PATH <- file.path(MARKET_ROOT, "skills", "onet", "Skills-2.xlsx")
ONET_EDU_PATH <- file.path(MARKET_ROOT, "skills", "onet",
                            "Education__Training__and_Experience.xlsx")

# SOC crosswalk
soc_crosswalk <- tribble(
  ~shrs_program, ~shrs_dept, ~soc_code, ~occupation_title,
  "SLP", "CSD", "29-1127", "Speech-Language Pathologists",
  "AuD", "CSD", "29-1181", "Audiologists",
  "DN",  "SMN", "29-1031", "Dietitians and Nutritionists",
  "AT",  "SMN", "29-9091", "Athletic Trainers",
  "SS",  "SMN", "29-1128", "Exercise Physiologists"
)

target_socs <- soc_crosswalk$soc_code

# Color palette for consistent styling
program_colors <- c(
  "SLP" = "#2c7bb6", "AuD" = "#abd9e9",
  "DN"  = "#d7191c", "AT"  = "#fdae61", "SS" = "#1a9641"
)
```

---

# 1 — BLS Skill Profiles (Broad View)

BLS Table 6.5 provides percentile ranks (0–100) across 17 skill dimensions for
each occupation. Higher = that skill is more important relative to all other
occupations in the economy.

```{r bls-skills-load}
bls_skills_wide <- read_excel(BLS_SKILLS_PATH, sheet = "Table 6.5", skip = 1,
                               col_types = "text") |>
  clean_names()

# Rename first two columns by position
names(bls_skills_wide)[1] <- "occupation_title"
names(bls_skills_wide)[2] <- "soc_code"

# Filter to our targets and pivot long
bls_skills <- bls_skills_wide |>
  filter(soc_code %in% target_socs) |>
  pivot_longer(cols = -c(occupation_title, soc_code),
               names_to = "skill", values_to = "percentile") |>
  mutate(
    percentile = as.numeric(percentile),
    skill = str_replace_all(skill, "_", " ") |> str_to_title()
  ) |>
  left_join(soc_crosswalk, by = "soc_code")
```

## 1.1 Skill Heatmap — All Programs

```{r bls-heatmap, fig.height=8, fig.width=10}
bls_skills |>
  ggplot(aes(x = shrs_program, y = reorder(skill, percentile), fill = percentile)) +
  geom_tile(color = "white", linewidth = 0.5) +
  geom_text(aes(label = percentile), size = 3.2, color = "black") +
  scale_fill_gradient2(low = "#d73027", mid = "#fee08b", high = "#1a9850",
                        midpoint = 50, limits = c(0, 100),
                        name = "Percentile\nRank") +
  labs(
    title = "BLS Skill Percentile Ranks by SHRS Program",
    subtitle = "0 = lowest across all occupations; 100 = highest",
    x = NULL, y = NULL
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(face = "bold"),
        panel.grid = element_blank())
```

## 1.2 Radar Charts by Program

```{r bls-radar, fig.height=10, fig.width=10}
# Faceted bar chart (more readable than true radar in R)
bls_skills |>
  ggplot(aes(x = reorder(skill, percentile), y = percentile,
             fill = shrs_program)) +
  geom_col(width = 0.7) +
  geom_hline(yintercept = 50, linetype = "dashed", color = "gray50") +
  coord_flip() +
  facet_wrap(~ shrs_program, ncol = 2) +
  scale_fill_manual(values = program_colors) +
  scale_y_continuous(limits = c(0, 100)) +
  labs(
    title = "Skill Profiles by SHRS Program (BLS Percentile Ranks)",
    subtitle = "Dashed line = 50th percentile (median across all occupations)",
    x = NULL, y = "Percentile Rank (0–100)"
  ) +
  theme_minimal(base_size = 11) +
  theme(legend.position = "none")
```

## 1.3 Top 3 Skills per Program

```{r bls-top3}
bls_skills |>
  group_by(shrs_program) |>
  slice_max(percentile, n = 3) |>
  arrange(shrs_program, desc(percentile)) |>
  select(Program = shrs_program, Skill = skill, Percentile = percentile) |>
  kable() |>
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

## 1.4 Distinguishing Skills

Which skills most differentiate each program from the average of the other four?

```{r bls-distinguish}
# For each program, compute difference from mean of other programs
bls_diff <- bls_skills |>
  group_by(skill) |>
  mutate(
    others_mean = (sum(percentile) - percentile) / 4
  ) |>
  ungroup() |>
  mutate(diff_from_others = percentile - others_mean)

bls_diff |>
  group_by(shrs_program) |>
  slice_max(abs(diff_from_others), n = 5) |>
  arrange(shrs_program, desc(diff_from_others)) |>
  select(Program = shrs_program, Skill = skill,
         Percentile = percentile, `Others Avg` = others_mean,
         `Difference` = diff_from_others) |>
  mutate(across(where(is.numeric), ~ round(.x, 1))) |>
  kable() |>
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

---

# 2 — O\*NET Detailed Skill Breakdown

O\*NET provides 35 specific skills scored on importance (1–5 scale) and level
(1–7 scale). We focus on **importance** scores to understand what matters most
for each occupation.

```{r onet-skills-load}
onet_raw <- read_excel(ONET_SKILLS_PATH, sheet = "Skills") |>
  clean_names()

# Filter: our target SOCs, importance scores only, not suppressed
onet_skills <- onet_raw |>
  mutate(soc_code = str_sub(o_net_soc_code, 1, 7)) |>
  filter(soc_code %in% target_socs,
         scale_id == "IM",
         recommend_suppress != "Y" | is.na(recommend_suppress)) |>
  select(soc_code, title, skill = element_name,
         importance = data_value) |>
  left_join(soc_crosswalk, by = "soc_code")
```

## 2.1 Top 10 Skills by Program (Importance)

```{r onet-top10, fig.height=10, fig.width=10}
onet_skills |>
  group_by(shrs_program) |>
  slice_max(importance, n = 10) |>
  ggplot(aes(x = reorder(skill, importance), y = importance,
             fill = shrs_program)) +
  geom_col(width = 0.7) +
  coord_flip() +
  facet_wrap(~ shrs_program, ncol = 2, scales = "free_y") +
  scale_fill_manual(values = program_colors) +
  scale_y_continuous(limits = c(0, 5)) +
  labs(
    title = "Top 10 Most Important Skills by SHRS Program",
    subtitle = "O*NET Importance Score (1–5 scale)",
    x = NULL, y = "Importance"
  ) +
  theme_minimal(base_size = 11) +
  theme(legend.position = "none")
```

## 2.2 Full O\*NET Skill Heatmap

```{r onet-heatmap, fig.height=12, fig.width=10}
onet_skills |>
  ggplot(aes(x = shrs_program, y = reorder(skill, importance), fill = importance)) +
  geom_tile(color = "white", linewidth = 0.3) +
  geom_text(aes(label = round(importance, 1)), size = 2.8) +
  scale_fill_gradient2(low = "#d73027", mid = "#fee08b", high = "#1a9850",
                        midpoint = 2.5, limits = c(1, 5),
                        name = "Importance\n(1–5)") +
  labs(
    title = "O*NET Skill Importance Across SHRS Programs",
    subtitle = "35 skills rated by importance (1 = not important, 5 = extremely important)",
    x = NULL, y = NULL
  ) +
  theme_minimal(base_size = 12) +
  theme(axis.text.x = element_text(face = "bold"),
        panel.grid = element_blank())
```

## 2.3 Skill Clusters

Group the 35 O\*NET skills into functional clusters to see where each program's
strengths concentrate.

```{r onet-clusters}
# Define skill clusters
cluster_map <- tribble(
  ~skill,                              ~cluster,
  "Active Listening",                  "Communication",
  "Speaking",                          "Communication",
  "Writing",                           "Communication",
  "Reading Comprehension",             "Communication",
  "Social Perceptiveness",             "Interpersonal",
  "Coordination",                      "Interpersonal",
  "Persuasion",                        "Interpersonal",
  "Negotiation",                       "Interpersonal",
  "Instructing",                       "Interpersonal",
  "Service Orientation",               "Interpersonal",
  "Critical Thinking",                 "Analytical",
  "Complex Problem Solving",           "Analytical",
  "Judgment and Decision Making",      "Analytical",
  "Systems Analysis",                  "Analytical",
  "Systems Evaluation",                "Analytical",
  "Operations Analysis",               "Analytical",
  "Active Learning",                   "Learning & Adaptability",
  "Learning Strategies",               "Learning & Adaptability",
  "Monitoring",                        "Learning & Adaptability",
  "Time Management",                   "Management",
  "Management of Personnel Resources", "Management",
  "Management of Material Resources",  "Management",
  "Management of Financial Resources", "Management",
  "Quality Control Analysis",          "Technical",
  "Technology Design",                 "Technical",
  "Equipment Selection",               "Technical",
  "Installation",                      "Technical",
  "Programming",                       "Technical",
  "Operations Monitoring",             "Technical",
  "Operation and Control",             "Technical",
  "Equipment Maintenance",             "Technical",
  "Troubleshooting",                   "Technical",
  "Repairing",                         "Technical",
  "Mathematics",                       "Science & Math",
  "Science",                           "Science & Math"
)

onet_clustered <- onet_skills |>
  left_join(cluster_map, by = "skill") |>
  filter(!is.na(cluster)) |>
  group_by(shrs_program, cluster) |>
  summarise(avg_importance = mean(importance, na.rm = TRUE), .groups = "drop")

onet_clustered |>
  ggplot(aes(x = cluster, y = avg_importance, fill = shrs_program)) +
  geom_col(position = "dodge", width = 0.7) +
  scale_fill_manual(values = program_colors) +
  scale_y_continuous(limits = c(0, 5)) +
  labs(
    title = "Average Skill Importance by Cluster",
    subtitle = "O*NET skills grouped into functional categories",
    x = NULL, y = "Average Importance (1–5)", fill = "Program"
  ) +
  theme_minimal(base_size = 12) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))
```

```{r cluster-heatmap, fig.height=5}
onet_clustered |>
  ggplot(aes(x = shrs_program, y = cluster, fill = avg_importance)) +
  geom_tile(color = "white", linewidth = 0.5) +
  geom_text(aes(label = round(avg_importance, 2)), size = 3.5) +
  scale_fill_gradient2(low = "#d73027", mid = "#fee08b", high = "#1a9850",
                        midpoint = 2.5, limits = c(1, 5),
                        name = "Avg\nImportance") +
  labs(
    title = "Skill Cluster Heatmap by SHRS Program",
    x = NULL, y = NULL
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(face = "bold"),
        panel.grid = element_blank())
```

---

# 3 — Education & Training Pathways

What education, experience, and training does the labor market actually require
for each SHRS occupation? This directly informs whether program structures are
aligned with market expectations.

```{r edu-load}
edu_raw <- read_excel(ONET_EDU_PATH,
                       sheet = "Education, Training, and Experi") |>
  clean_names()

edu_raw <- edu_raw |>
  mutate(soc_code = str_sub(o_net_soc_code, 1, 7)) |>
  filter(soc_code %in% target_socs) |>
  left_join(soc_crosswalk, by = "soc_code")
```

## 3.1 Education Level Distribution

What percentage of workers in each occupation hold each education level?

```{r edu-dist, fig.height=6}
edu_labels <- tribble(
  ~category, ~edu_level,
  1,  "Less than HS",
  2,  "HS Diploma/GED",
  3,  "Post-secondary Certificate",
  4,  "Some College",
  5,  "Associate's Degree",
  6,  "Bachelor's Degree",
  7,  "Post-baccalaureate Certificate",
  8,  "Master's Degree",
  9,  "Post-master's Certificate",
  10, "First Professional Degree",
  11, "Doctoral Degree",
  12, "Post-doctoral Training"
)

edu_dist <- edu_raw |>
  filter(element_id == "2.D.1", scale_id == "RL") |>
  mutate(category = as.integer(category),
         pct = as.numeric(data_value)) |>
  filter(pct > 0) |>
  left_join(edu_labels, by = "category") |>
  mutate(edu_level = factor(edu_level, levels = edu_labels$edu_level))

edu_dist |>
  ggplot(aes(x = shrs_program, y = pct, fill = edu_level)) +
  geom_col(width = 0.7) +
  scale_fill_viridis_d(option = "D", direction = -1, name = "Education Level") +
  labs(
    title = "Education Level Distribution by SHRS Occupation",
    subtitle = "Percent of workers at each education level (O*NET incumbent survey)",
    x = NULL, y = "Percent of Workers (%)"
  ) +
  theme_minimal(base_size = 13) +
  theme(legend.position = "right")
```

```{r edu-table}
edu_dist |>
  select(Program = shrs_program, `Education Level` = edu_level,
         `% of Workers` = pct) |>
  mutate(`% of Workers` = round(`% of Workers`, 1)) |>
  kable() |>
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

## 3.2 Related Work Experience Requirements

How much prior experience does each occupation expect?

```{r exp-dist, fig.height=6}
exp_labels <- tribble(
  ~category, ~experience,
  1,  "None",
  2,  "Up to 1 month",
  3,  "1–3 months",
  4,  "3–6 months",
  5,  "6 months–1 year",
  6,  "1–2 years",
  7,  "2–4 years",
  8,  "4–6 years",
  9,  "6–10 years",
  10, "Over 10 years",
  11, "Missing"
)

exp_dist <- edu_raw |>
  filter(element_id == "3.A.1", scale_id == "RW") |>
  mutate(category = as.integer(category),
         pct = as.numeric(data_value)) |>
  filter(pct > 0, category != 11) |>
  left_join(exp_labels, by = "category") |>
  mutate(experience = factor(experience, levels = exp_labels$experience))

exp_dist |>
  ggplot(aes(x = shrs_program, y = pct, fill = experience)) +
  geom_col(width = 0.7) +
  scale_fill_viridis_d(option = "C", direction = -1, name = "Experience") +
  labs(
    title = "Related Work Experience Distribution by SHRS Occupation",
    subtitle = "Percent of workers reporting each level of prior experience (O*NET)",
    x = NULL, y = "Percent of Workers (%)"
  ) +
  theme_minimal(base_size = 13) +
  theme(legend.position = "right")
```

## 3.3 On-the-Job Training Requirements

```{r ojt-dist, fig.height=5}
ojt_labels <- tribble(
  ~category, ~training,
  1, "None",
  2, "1 day to 1 month",
  3, "1–3 months",
  4, "3–6 months",
  5, "6 months–1 year",
  6, "1–2 years",
  7, "2–4 years",
  8, "4–10 years",
  9, "Over 10 years"
)

ojt_dist <- edu_raw |>
  filter(element_id == "3.A.3", scale_id == "OJ") |>
  mutate(category = as.integer(category),
         pct = as.numeric(data_value)) |>
  filter(pct > 0) |>
  left_join(ojt_labels, by = "category") |>
  mutate(training = factor(training, levels = ojt_labels$training))

if (nrow(ojt_dist) > 0) {
  ojt_dist |>
    ggplot(aes(x = shrs_program, y = pct, fill = training)) +
    geom_col(width = 0.7) +
    scale_fill_viridis_d(option = "B", direction = -1, name = "OJT Duration") +
    labs(
      title = "On-the-Job Training Requirements by SHRS Occupation",
      subtitle = "O*NET incumbent survey",
      x = NULL, y = "Percent of Workers (%)"
    ) +
    theme_minimal(base_size = 13) +
    theme(legend.position = "right")
}
```

---

# 4 — Skills & Education Synthesis

Bringing together the skill profiles and education pathways into a single
program-level summary.

```{r synthesis}
# Dominant education level per program
dominant_edu <- edu_dist |>
  group_by(shrs_program) |>
  slice_max(pct, n = 1) |>
  select(shrs_program, dominant_edu = edu_level, edu_pct = pct)

# Top skill cluster per program
top_cluster <- onet_clustered |>
  group_by(shrs_program) |>
  slice_max(avg_importance, n = 1) |>
  select(shrs_program, top_cluster = cluster, cluster_importance = avg_importance)

# Top BLS skill per program
top_bls_skill <- bls_skills |>
  group_by(shrs_program) |>
  slice_max(percentile, n = 1) |>
  select(shrs_program, top_bls_skill = skill, top_percentile = percentile)

# Average O*NET importance (overall skill intensity)
avg_intensity <- onet_skills |>
  group_by(shrs_program) |>
  summarise(avg_skill_importance = round(mean(importance, na.rm = TRUE), 2),
            .groups = "drop")

# Combine
synthesis <- soc_crosswalk |>
  select(shrs_program, shrs_dept) |>
  left_join(dominant_edu, by = "shrs_program") |>
  left_join(top_cluster, by = "shrs_program") |>
  left_join(top_bls_skill, by = "shrs_program") |>
  left_join(avg_intensity, by = "shrs_program")
```

```{r synthesis-table}
synthesis |>
  select(
    Program            = shrs_program,
    Dept               = shrs_dept,
    `Primary Education`  = dominant_edu,
    `% at that Level`    = edu_pct,
    `Top Skill Cluster`  = top_cluster,
    `Top BLS Skill`      = top_bls_skill,
    `Skill Intensity`    = avg_skill_importance
  ) |>
  kable(digits = 1) |>
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

## 4.1 Program Positioning Map

```{r positioning, fig.height=6}
# Use skill intensity vs education level as a 2D positioning
edu_numeric <- tribble(
  ~dominant_edu,                      ~edu_years,
  "Less than HS",                     10,
  "HS Diploma/GED",                   12,
  "Post-secondary Certificate",       13,
  "Some College",                     14,
  "Associate's Degree",               14,
  "Bachelor's Degree",                16,
  "Post-baccalaureate Certificate",   17,
  "Master's Degree",                  18,
  "Post-master's Certificate",        19,
  "First Professional Degree",        20,
  "Doctoral Degree",                  21,
  "Post-doctoral Training",           22
)

positioning <- synthesis |>
  left_join(edu_numeric, by = "dominant_edu")

positioning |>
  ggplot(aes(x = edu_years, y = avg_skill_importance,
             color = shrs_program, label = shrs_program)) +
  geom_point(size = 5) +
  geom_text(vjust = -1.2, size = 4.5, fontface = "bold") +
  scale_color_manual(values = program_colors) +
  scale_x_continuous(
    breaks = c(16, 18, 21),
    labels = c("Bachelor's", "Master's", "Doctoral")
  ) +
  labs(
    title = "Program Positioning: Education Level vs Skill Intensity",
    subtitle = "Where each SHRS program sits in terms of training investment and skill demands",
    x = "Dominant Education Level", y = "Average Skill Importance (O*NET 1–5)"
  ) +
  theme_minimal(base_size = 13) +
  theme(legend.position = "none")
```

---

# Appendix: Data Sources

- **BLS Skills Data**: Table 6.5 from Employment Projections program — percentile ranks across 17 skill dimensions
- **O\*NET Skills**: 35 detailed skills with importance and level ratings from incumbent worker surveys
- **O\*NET Education, Training & Experience**: Education distributions, work experience requirements, and on-the-job training from incumbent surveys
