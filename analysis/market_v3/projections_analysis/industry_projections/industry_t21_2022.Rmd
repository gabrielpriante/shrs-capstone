---
title: "SHRS Market Analysis — Industry Employment by Sector (2022 Vintage)"
subtitle: "BLS Employment Projections Table 2.1 · 2022–2032 Cycle"
author: "SHRS MQE Capstone Team"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo    = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 6
)
```

# 0 — Setup

```{r packages}
library(tidyverse)
library(scales)
library(knitr)
library(kableExtra)
```

```{r config}
# ── SOC crosswalk (self-contained) ──
soc_crosswalk <- tribble(
  ~shrs_program, ~shrs_dept, ~soc_code,  ~occupation_title,
  "SLP",         "CSD",      "29-1127",  "Speech-Language Pathologists",
  "AuD",         "CSD",      "29-1181",  "Audiologists",
  "HIM",         "HIM",      "29-9021",  "Health Information Technologists and Medical Registrars",
  "OTD",         "RST",      "29-1122",  "Occupational Therapists",
  "DPT",         "RST",      "29-1123",  "Physical Therapists",
  "PAS",         "PAS",      "29-1071",  "Physician Assistants",
  "AT",          "SMN",      "29-9091",  "Athletic Trainers",
  "DN",          "SMN",      "29-1031",  "Dietitians and Nutritionists",
  "SS",          "SMN",      "29-1128",  "Exercise Physiologists"
)

# ── File path (edit for your machine) ──
DATA_PATH <- "/Users/gpps/Documents/SHRS_Analysis/market_analysis/v3data/projections_csv/industry_csv/2022/2022_industry-2022 - Table 2.1.csv"

VINTAGE <- 2022
CYCLE   <- "2022-2032"
```

```{r helpers}
clean_num <- function(x) {
  x <- str_remove_all(x, ",")
  x <- str_replace_all(x, "—|–|-", NA_character_)
  as.numeric(x)
}
```

---

# 1 — Load & Clean Data

**CRITICAL STRUCTURAL NOTE:** The 2022 vintage Table 2.1 is **very different**
from 2023/2024:

- **12 columns** (not 14) — no separate percent-change columns for employment
- Contains **blank separator rows** between sections
- Has **no "Total employment" top row** in the same format — instead uses "All industries"
- Groups sectors differently (e.g., "Health care and social assistance" not "Healthcare and social assistance; private")
- Uses "NA" for NAICS codes of non-sector rows

**Column layout (12 columns):**

| Pos | Content |
|-----|---------|
| 1 | Industry Sector |
| 2 | 2022 NAICS |
| 3 | Employment, 2012 (thousands) |
| 4 | Employment, 2022 (thousands) |
| 5 | Employment, 2032 (thousands) |
| 6 | Employment change, 2012–22 (numeric, thousands) |
| 7 | Employment change, 2022–32 (numeric, thousands) |
| 8 | Percent distribution, 2012 |
| 9 | Percent distribution, 2022 |
| 10 | Percent distribution, 2032 |
| 11 | Compound annual rate of change, 2012–22 |
| 12 | Compound annual rate of change, 2022–32 |

**No explicit percent-change columns** — we must compute growth % from the
numeric change and base employment.

```{r load-data}
raw <- read_csv(DATA_PATH, col_types = cols(.default = "c"), col_names = FALSE)

colnames(raw) <- c(
  "industry_sector", "naics",
  "emp_hist", "emp_base", "emp_proj",
  "emp_change_hist", "emp_change_proj",
  "pct_dist_hist", "pct_dist_base", "pct_dist_proj",
  "cagr_hist", "cagr_proj"
)

# Drop header row
raw <- raw[-1, ]

# Clean footnote markers
raw <- raw %>%
  mutate(industry_sector = str_remove_all(industry_sector, "\\(\\d+\\)|\\[\\d+\\]") %>%
           str_trim())

# Remove blank rows (separator rows)
raw <- raw %>%
  filter(!is.na(industry_sector) & industry_sector != "")

# Convert numeric columns
df <- raw %>%
  mutate(across(-c(industry_sector, naics), clean_num))

# Compute percent change (missing in this vintage)
df <- df %>%
  mutate(
    emp_pct_hist = round((emp_change_hist / emp_hist) * 100, 1),
    emp_pct_proj = round((emp_change_proj / emp_base) * 100, 1)
  )

cat("Loaded", nrow(df), "rows for", CYCLE, "cycle (after removing blank rows)\n")
```

```{r preview}
df %>%
  select(industry_sector, naics, emp_base, emp_proj, emp_pct_proj, cagr_proj) %>%
  head(10) %>%
  kable(digits = 1, format.args = list(big.mark = ","),
        caption = "Table 2.1 Preview — First 10 Rows (with computed growth %)") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

---

# 2 — Total Economy Benchmark

```{r benchmarks}
# "All industries" is the total row in this vintage
total_row <- df %>%
  filter(str_detect(industry_sector, regex("^All industries", ignore_case = TRUE))) %>%
  slice(1)

total_emp_base     <- total_row$emp_base
total_emp_proj     <- total_row$emp_proj
total_change_proj  <- total_row$emp_change_proj
total_pct_proj     <- total_row$emp_pct_proj
total_cagr_proj    <- total_row$cagr_proj

cat("Total Economy (", CYCLE, "):\n")
cat("  Base employment:      ", comma(total_emp_base * 1000), "\n")
cat("  Projected employment: ", comma(total_emp_proj * 1000), "\n")
cat("  Projected change:     ", comma(total_change_proj * 1000),
    " (", total_pct_proj, "%)\n")
cat("  CAGR:                 ", total_cagr_proj, "%\n")
```

---

# 3 — Sector Employment Overview

## 3.1 Employment by Sector (Current)

```{r sector-bar, fig.height=8}
# Filter to actual sectors — exclude totals, sub-headings, and ag self-employed rows
sectors <- df %>%
  filter(!is.na(emp_base),
         !str_detect(industry_sector,
           regex("^All industries|^Nonagriculture wage|^Goods-producing|^Service-providing|self-employed",
                 ignore_case = TRUE))) %>%
  mutate(sector_clean = str_trim(industry_sector))

sectors <- sectors %>%
  mutate(is_healthcare = str_detect(sector_clean,
    regex("health care|healthcare|social assistance", ignore_case = TRUE)))

sectors %>%
  filter(!is.na(emp_base), emp_base > 0) %>%
  ggplot(aes(x = reorder(sector_clean, emp_base), y = emp_base,
             fill = is_healthcare)) +
  geom_col(width = 0.7) +
  geom_text(aes(label = comma(emp_base, accuracy = 0.1)),
            hjust = -0.05, size = 3.2) +
  coord_flip() +
  scale_fill_manual(values = c("FALSE" = "#b0c4de", "TRUE" = "#d7191c"),
                    labels = c("Other Sectors", "Healthcare & Social Assistance"),
                    name = NULL) +
  scale_y_continuous(labels = comma, expand = expansion(mult = c(0, 0.2))) +
  labs(
    title = paste0("Employment by Industry Sector (", VINTAGE, ", thousands)"),
    subtitle = paste0("BLS Table 2.1 — ", CYCLE, " projections cycle"),
    x = NULL, y = "Employment (thousands)"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom")
```

## 3.2 Projected Growth Rate by Sector

```{r sector-growth, fig.height=8}
sectors %>%
  filter(!is.na(emp_pct_proj)) %>%
  ggplot(aes(x = reorder(sector_clean, emp_pct_proj), y = emp_pct_proj,
             fill = is_healthcare)) +
  geom_col(width = 0.7) +
  geom_hline(yintercept = total_pct_proj, linetype = "dashed",
             color = "gray40", linewidth = 0.7) +
  annotate("text", x = 2, y = total_pct_proj + 0.3,
           label = paste0("All industries: ", total_pct_proj, "%"),
           hjust = 0, size = 3.5, color = "gray40") +
  coord_flip() +
  scale_fill_manual(values = c("FALSE" = "#b0c4de", "TRUE" = "#d7191c"),
                    labels = c("Other Sectors", "Healthcare & Social Assistance"),
                    name = NULL) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.2))) +
  labs(
    title = paste0("Projected Employment Growth by Sector (", CYCLE, ")"),
    subtitle = "Dashed line = all-industry benchmark | Growth % computed from numeric change",
    x = NULL, y = "Projected Growth (%)"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom")
```

## 3.3 CAGR Comparison

```{r sector-cagr, fig.height=8}
sectors %>%
  filter(!is.na(cagr_proj)) %>%
  ggplot(aes(x = reorder(sector_clean, cagr_proj), y = cagr_proj,
             fill = is_healthcare)) +
  geom_col(width = 0.7) +
  geom_hline(yintercept = total_cagr_proj, linetype = "dashed",
             color = "gray40", linewidth = 0.7) +
  coord_flip() +
  scale_fill_manual(values = c("FALSE" = "#b0c4de", "TRUE" = "#d7191c"),
                    labels = c("Other Sectors", "Healthcare & Social Assistance"),
                    name = NULL) +
  labs(
    title = paste0("Compound Annual Growth Rate by Sector (", CYCLE, ")"),
    subtitle = "Dashed line = all-industry CAGR",
    x = NULL, y = "CAGR (%)"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom")
```

---

# 4 — Healthcare Sector Deep-Dive

```{r healthcare-extract}
hc_row <- sectors %>%
  filter(is_healthcare) %>%
  slice(1)

hc_emp_base      <- hc_row$emp_base
hc_emp_proj      <- hc_row$emp_proj
hc_pct_proj      <- hc_row$emp_pct_proj
hc_cagr_proj     <- hc_row$cagr_proj
hc_pct_dist_base <- hc_row$pct_dist_base
hc_pct_dist_proj <- hc_row$pct_dist_proj

cat("Healthcare & Social Assistance (", CYCLE, "):\n")
cat("  Base employment:       ", comma(hc_emp_base * 1000), "\n")
cat("  Projected employment:  ", comma(hc_emp_proj * 1000), "\n")
cat("  Projected growth:      ", hc_pct_proj, "%\n")
cat("  CAGR:                  ", hc_cagr_proj, "%\n")
cat("  Share of economy (base):", hc_pct_dist_base, "%\n")
cat("  Share of economy (proj):", hc_pct_dist_proj, "%\n")
```

## 4.1 Healthcare vs Economy Growth

```{r hc-vs-economy}
comparison <- tribble(
  ~metric,                          ~healthcare, ~all_industries,
  "Projected Growth (%)",           hc_pct_proj,  total_pct_proj,
  "CAGR (%)",                       hc_cagr_proj, total_cagr_proj
)

comparison %>%
  pivot_longer(-metric, names_to = "category", values_to = "value") %>%
  mutate(category = if_else(category == "healthcare",
                            "Healthcare & Social Assistance", "All Industries")) %>%
  ggplot(aes(x = metric, y = value, fill = category)) +
  geom_col(position = "dodge", width = 0.6) +
  geom_text(aes(label = paste0(value, "%")),
            position = position_dodge(width = 0.6), vjust = -0.5, size = 4) +
  scale_fill_manual(values = c("Healthcare & Social Assistance" = "#d7191c",
                                "All Industries" = "#b0c4de")) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.25))) +
  labs(
    title = paste0("Healthcare vs Total Economy — Growth Comparison (", CYCLE, ")"),
    x = NULL, y = "Rate (%)", fill = NULL
  ) +
  theme_minimal(base_size = 13) +
  theme(legend.position = "bottom")
```

## 4.2 Healthcare's Growing Share of the Economy

```{r hc-share}
hc_share_hist <- hc_row$pct_dist_hist

share_df <- tibble(
  year = c(VINTAGE - 10, VINTAGE, VINTAGE + 10),
  share = c(hc_share_hist, hc_pct_dist_base, hc_pct_dist_proj)
) %>%
  filter(!is.na(share))

share_df %>%
  ggplot(aes(x = year, y = share)) +
  geom_line(linewidth = 1.2, color = "#d7191c") +
  geom_point(size = 4, color = "#d7191c") +
  geom_text(aes(label = paste0(share, "%")), vjust = -1.2, size = 4.5) +
  scale_y_continuous(limits = c(0, max(share_df$share, na.rm = TRUE) + 3)) +
  labs(
    title = "Healthcare & Social Assistance: Growing Share of Total Employment",
    subtitle = paste0("Percent of total employment, ", min(share_df$year),
                      "–", max(share_df$year)),
    x = NULL, y = "% of Total Employment"
  ) +
  theme_minimal(base_size = 13)
```

---

# 5 — Sector Ranking & Healthcare Context for SHRS

## 5.1 Sector Rankings

```{r sector-rankings}
rankings <- sectors %>%
  filter(!is.na(emp_pct_proj)) %>%
  mutate(
    rank_growth = rank(-emp_pct_proj),
    rank_size   = rank(-emp_base),
    rank_cagr   = rank(-cagr_proj)
  )

hc_rankings <- rankings %>% filter(is_healthcare)

cat("Healthcare & Social Assistance Rankings:\n")
cat("  Growth rate rank:  ", hc_rankings$rank_growth, "of", nrow(rankings), "\n")
cat("  Employment size rank:", hc_rankings$rank_size, "of", nrow(rankings), "\n")
cat("  CAGR rank:         ", hc_rankings$rank_cagr, "of", nrow(rankings), "\n")
```

## 5.2 Full Sector Table

```{r full-sector-table}
rankings %>%
  arrange(rank_growth) %>%
  select(
    Sector         = sector_clean,
    `Emp Base (K)` = emp_base,
    `Emp Proj (K)` = emp_proj,
    `Growth (%)`   = emp_pct_proj,
    `CAGR (%)`     = cagr_proj,
    `Share Base (%)` = pct_dist_base,
    `Growth Rank`  = rank_growth
  ) %>%
  kable(digits = 1, format.args = list(big.mark = ","),
        caption = paste0("Industry Sectors Ranked by Projected Growth (", CYCLE, ")")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) %>%
  row_spec(which(rankings %>% arrange(rank_growth) %>% pull(is_healthcare)),
           bold = TRUE, background = "#ffe0e0")
```

---

# 6 — Industry Context Scorecard for SHRS

```{r scorecard}
growth_ratio <- hc_pct_proj / total_pct_proj
growth_score <- case_when(
  growth_ratio >= 3.0 ~ 100,
  growth_ratio >= 2.5 ~ 90,
  growth_ratio >= 2.0 ~ 80,
  growth_ratio >= 1.5 ~ 70,
  growth_ratio >= 1.0 ~ 60,
  growth_ratio >= 0.5 ~ 40,
  TRUE                ~ 20
)

size_score <- case_when(
  hc_pct_dist_base >= 15 ~ 100,
  hc_pct_dist_base >= 12 ~ 85,
  hc_pct_dist_base >= 10 ~ 70,
  hc_pct_dist_base >= 8  ~ 55,
  hc_pct_dist_base >= 5  ~ 40,
  TRUE                    ~ 20
)

share_change <- hc_pct_dist_proj - hc_pct_dist_base
trajectory_score <- case_when(
  share_change >= 1.0 ~ 100,
  share_change >= 0.5 ~ 80,
  share_change >= 0.0 ~ 60,
  share_change >= -0.5 ~ 40,
  TRUE                  ~ 20
)

cagr_ratio <- hc_cagr_proj / total_cagr_proj
cagr_score <- case_when(
  cagr_ratio >= 3.0 ~ 100,
  cagr_ratio >= 2.5 ~ 90,
  cagr_ratio >= 2.0 ~ 80,
  cagr_ratio >= 1.5 ~ 70,
  cagr_ratio >= 1.0 ~ 60,
  cagr_ratio >= 0.5 ~ 40,
  TRUE               ~ 20
)

composite_score <- round(mean(c(growth_score, size_score,
                                 trajectory_score, cagr_score)), 0)
signal <- case_when(
  composite_score >= 70 ~ "Green",
  composite_score >= 50 ~ "Yellow",
  TRUE                  ~ "Red"
)

scorecard_df <- tibble(
  Dimension = c("Growth Premium", "Market Size", "Share Trajectory",
                "CAGR Premium", "COMPOSITE"),
  Score     = c(growth_score, size_score, trajectory_score,
                cagr_score, composite_score),
  Signal    = c(
    if_else(growth_score >= 70, "Green", if_else(growth_score >= 50, "Yellow", "Red")),
    if_else(size_score >= 70, "Green", if_else(size_score >= 50, "Yellow", "Red")),
    if_else(trajectory_score >= 70, "Green", if_else(trajectory_score >= 50, "Yellow", "Red")),
    if_else(cagr_score >= 70, "Green", if_else(cagr_score >= 50, "Yellow", "Red")),
    signal
  ),
  Detail    = c(
    paste0("HC growth ", hc_pct_proj, "% vs ", total_pct_proj, "% all-industry (",
           round(growth_ratio, 2), "x)"),
    paste0("HC = ", hc_pct_dist_base, "% of total employment"),
    paste0("HC share moves ", hc_pct_dist_base, "% → ", hc_pct_dist_proj,
           "% (+", round(share_change, 1), " pp)"),
    paste0("HC CAGR ", hc_cagr_proj, "% vs ", total_cagr_proj, "% all-industry (",
           round(cagr_ratio, 2), "x)"),
    paste0("Average of 4 dimensions")
  )
)
```

```{r scorecard-table}
scorecard_df %>%
  kable(caption = paste0("Industry Context Scorecard — Healthcare Sector (",
                          CYCLE, ")")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) %>%
  row_spec(which(scorecard_df$Signal == "Green"),
           background = "#d4edda", color = "#155724") %>%
  row_spec(which(scorecard_df$Signal == "Yellow"),
           background = "#fff3cd", color = "#856404") %>%
  row_spec(which(scorecard_df$Signal == "Red"),
           background = "#f8d7da", color = "#721c24") %>%
  row_spec(5, bold = TRUE)
```

```{r scorecard-viz}
scorecard_df %>%
  filter(Dimension != "COMPOSITE") %>%
  ggplot(aes(x = reorder(Dimension, Score), y = Score,
             fill = Signal)) +
  geom_col(width = 0.6) +
  geom_text(aes(label = Score), hjust = -0.2, size = 4.5, fontface = "bold") +
  geom_hline(yintercept = 70, linetype = "dashed", color = "#155724", linewidth = 0.5) +
  geom_hline(yintercept = 50, linetype = "dashed", color = "#856404", linewidth = 0.5) +
  coord_flip() +
  scale_fill_manual(values = c("Green" = "#28a745", "Yellow" = "#ffc107",
                                "Red" = "#dc3545")) +
  scale_y_continuous(limits = c(0, 110)) +
  labs(
    title = paste0("Industry Context Scorecard (", CYCLE, ")"),
    subtitle = "Healthcare & Social Assistance sector health relative to total economy",
    x = NULL, y = "Score (0–100)"
  ) +
  theme_minimal(base_size = 13) +
  theme(legend.position = "none")
```

---

# 7 — Stored Outputs

```{r stored-outputs}
ind_t21_2022_vintage       <- VINTAGE
ind_t21_2022_cycle         <- CYCLE
ind_t21_2022_total_emp     <- total_emp_base
ind_t21_2022_total_proj    <- total_emp_proj
ind_t21_2022_total_pct     <- total_pct_proj
ind_t21_2022_total_cagr    <- total_cagr_proj
ind_t21_2022_hc_emp        <- hc_emp_base
ind_t21_2022_hc_proj       <- hc_emp_proj
ind_t21_2022_hc_pct        <- hc_pct_proj
ind_t21_2022_hc_cagr       <- hc_cagr_proj
ind_t21_2022_hc_share_base <- hc_pct_dist_base
ind_t21_2022_hc_share_proj <- hc_pct_dist_proj
ind_t21_2022_growth_ratio  <- growth_ratio
ind_t21_2022_scorecard     <- scorecard_df
ind_t21_2022_composite     <- composite_score
ind_t21_2022_signal        <- signal
ind_t21_2022_sectors       <- rankings
```

```{r output-registry}
output_registry <- tribble(
  ~variable,                         ~description,
  "ind_t21_2022_vintage",            "Projection vintage year (2022)",
  "ind_t21_2022_cycle",              "Projection cycle label (2022-2032)",
  "ind_t21_2022_total_emp",          "Total employment, base year (thousands)",
  "ind_t21_2022_total_proj",         "Total employment, projected (thousands)",
  "ind_t21_2022_total_pct",          "Total employment projected growth % (computed)",
  "ind_t21_2022_total_cagr",         "Total employment CAGR %",
  "ind_t21_2022_hc_emp",             "Healthcare & social assistance employment, base (thousands)",
  "ind_t21_2022_hc_proj",            "Healthcare & social assistance employment, projected (thousands)",
  "ind_t21_2022_hc_pct",             "Healthcare sector projected growth % (computed)",
  "ind_t21_2022_hc_cagr",            "Healthcare sector CAGR %",
  "ind_t21_2022_hc_share_base",      "Healthcare share of total employment, base year %",
  "ind_t21_2022_hc_share_proj",      "Healthcare share of total employment, projected %",
  "ind_t21_2022_growth_ratio",       "Healthcare growth / all-industry growth ratio",
  "ind_t21_2022_scorecard",          "Full scorecard dataframe (4 dimensions + composite)",
  "ind_t21_2022_composite",          "Composite scorecard score (0-100)",
  "ind_t21_2022_signal",             "Overall signal: Green/Yellow/Red",
  "ind_t21_2022_sectors",            "Full sector-level dataframe with rankings"
)

output_registry %>%
  kable(caption = "Output Variable Registry — industry_t21_2022.Rmd") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```
