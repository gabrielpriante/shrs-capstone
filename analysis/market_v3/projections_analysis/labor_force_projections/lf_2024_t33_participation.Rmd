---
title: "SHRS Market Analysis — 2024 Participation Rates (Table 3.3)"
author: "SHRS MQE Capstone Team"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, message=FALSE, warning=FALSE, fig.width=10, fig.height=6)
```

```{r packages}
library(tidyverse); library(scales); library(knitr); library(kableExtra)
```

# 0 — Configuration

```{r config}
VINTAGE <- "2024"
YR1 <- 2004; YR2 <- 2014; YR3 <- 2024; YR4 <- 2034
PROJ_LABEL <- paste0(YR3, "-", YR4)

CSV_PATH <- file.path(path.expand("~"), "Documents", "SHRS_Analysis",
                       "market_analysis", "v3data", "projections_csv",
                       "labor_force_csv", VINTAGE,
                       paste0("labor-force_", VINTAGE, " - Table 3.3.csv"))

signal_colors <- c("Green"="#27ae60","Yellow"="#f39c12","Red"="#e74c3c")
```

# 1 — Load & Clean

Table 3.3: Labor force participation rates by demographic group — the
share of each population segment that is working or actively seeking work.

```{r load}
raw <- read_csv(CSV_PATH, show_col_types = FALSE)

# 11 columns: Group + 4 rates + 3 rate changes + 3 CAGRs
names(raw) <- c("group",
                "rate_yr1","rate_yr2","rate_yr3","rate_yr4",
                "rate_chg_12","rate_chg_23","rate_chg_34",
                "cagr_12","cagr_23","cagr_34")

clean_num <- function(x) {
  x <- str_remove_all(as.character(x), ",")
  x[x %in% c("—","–","-","NA","")] <- NA
  suppressWarnings(as.numeric(x))
}

raw <- raw |>
  mutate(group = str_trim(group)) |>
  filter(group != "", !is.na(group)) |>
  mutate(across(-group, clean_num))
```

```{r dq, results='asis'}
cat(paste0("**Vintage:** ",VINTAGE," | **Rows:** ",nrow(raw),"\n"))
```

---

# 2 — Overall Participation Rate Trend

```{r total}
total <- raw |> filter(str_detect(group, "^Total"))

rate_trend <- tibble(
  Year = c(YR1, YR2, YR3, YR4),
  Rate = c(total$rate_yr1, total$rate_yr2, total$rate_yr3, total$rate_yr4),
  Type = c("Historical","Historical","Current","Projected")
)

rate_trend |>
  ggplot(aes(x=Year, y=Rate, color=Type)) +
  geom_line(linewidth=1.2, color="gray60") +
  geom_point(aes(fill=Type), shape=21, size=5, color="white", stroke=1.5) +
  geom_text(aes(label=paste0(Rate,"%")), vjust=-1.2, size=4) +
  scale_fill_manual(values=c("Historical"="#2c7bb6","Current"="#27ae60","Projected"="#f39c12")) +
  scale_y_continuous(limits=c(58,68)) +
  labs(title="Labor Force Participation Rate Trend",
       subtitle="Secular decline — fewer working-age adults actively in labor force",
       x=NULL, y="Participation Rate (%)", fill=NULL) +
  theme_minimal(base_size=13) + theme(legend.position="bottom")

# Store benchmarks
lfpr_current   <- total$rate_yr3
lfpr_projected <- total$rate_yr4
lfpr_change    <- total$rate_chg_34
```

```{r total-table}
tibble(
  Metric = c(paste0("LFPR ",YR1), paste0("LFPR ",YR2), paste0("LFPR ",YR3),
             paste0("LFPR ",YR4," (projected)"),
             paste0("Change ",YR1,"-",YR2," (pp)"), paste0("Change ",YR2,"-",YR3," (pp)"),
             paste0("Change ",YR3,"-",YR4," (pp)")),
  Value = c(total$rate_yr1, total$rate_yr2, total$rate_yr3, total$rate_yr4,
            total$rate_chg_12, total$rate_chg_23, total$rate_chg_34)
) |>
  kable(digits=1, caption="Overall LFPR Summary") |>
  kable_styling(bootstrap_options=c("striped","hover"), full_width=FALSE)
```

---

# 3 — Participation by Gender

```{r gender}
gender <- raw |> filter(str_detect(group, "^Men, 16|^Women, 16"))

gender |>
  select(Group=group, !!paste0("Rate ",YR3):=rate_yr3, !!paste0("Rate ",YR4):=rate_yr4,
         !!paste0("Change (pp)"):=rate_chg_34) |>
  kable(digits=1, caption="LFPR by Gender") |>
  kable_styling(bootstrap_options=c("striped","hover"), full_width=FALSE)
```

---

# 4 — Participation by Age

```{r age, fig.height=7}
age <- raw |>
  filter(str_detect(group, "^\\s*\\d+\\s+to\\s+\\d+|^\\s*55 and|^\\s*65 and|^\\s*75 and")) |>
  mutate(group = str_trim(group))

if (nrow(age) > 0) {
  age |>
    ggplot(aes(x=reorder(group, rate_yr3), y=rate_yr3)) +
    geom_segment(aes(xend=group, y=rate_yr4, yend=rate_yr3),
                 color="gray70", linewidth=1) +
    geom_point(aes(color="Current"), size=4) +
    geom_point(aes(y=rate_yr4, color="Projected"), size=4) +
    coord_flip() +
    scale_color_manual(values=c("Current"="#2c7bb6","Projected"="#f39c12")) +
    labs(title=paste0("LFPR by Age Group: ",YR3," vs ",YR4," (Projected)"),
         subtitle="Dot = current rate; arrow = projected direction",
         x=NULL, y="Participation Rate (%)", color=NULL) +
    theme_minimal(base_size=12) + theme(legend.position="bottom")

  age |>
    select(Age=group, !!paste0("Rate ",YR3):=rate_yr3,
           !!paste0("Rate ",YR4):=rate_yr4, `Change (pp)`=rate_chg_34) |>
    kable(digits=1, caption="LFPR by Age Group") |>
    kable_styling(bootstrap_options=c("striped","hover"), full_width=FALSE)
}
```

---

# 5 — Participation by Race/Ethnicity

```{r race}
race <- raw |>
  filter(str_detect(group, "^White,|^Black,|^Asian,|^Hispanic origin,"))

if (nrow(race) > 0) {
  race |>
    select(Group=group, !!paste0("Rate ",YR3):=rate_yr3,
           !!paste0("Rate ",YR4):=rate_yr4, `Change (pp)`=rate_chg_34) |>
    kable(digits=1, caption="LFPR by Race/Ethnicity") |>
    kable_styling(bootstrap_options=c("striped","hover"), full_width=FALSE)
}
```

---

# 6 — Healthcare Workforce Implications

```{r implications, results='asis'}
cat("### Implications for SHRS Programs\n\n")
cat(paste0("- <span style='color:#2c7bb6;'>**Declining LFPR:**</span> Overall rate falling from ",
           lfpr_current, "% to ", lfpr_projected, "% (", lfpr_change,
           " pp) — fewer workers available per capita\n"))
cat(paste0("- <span style='color:#2c7bb6;'>**Aging-driven decline:**</span> ",
           "Older cohorts have lower participation rates; as they grow as ",
           "a share of the population, overall LFPR falls\n"))
cat(paste0("- <span style='color:#2c7bb6;'>**Healthcare demand paradox:**</span> ",
           "The same aging that shrinks the labor supply *increases* demand for ",
           "rehabilitation, therapy, and health services — creating favorable ",
           "conditions for SHRS graduates\n"))
cat(paste0("- <span style='color:#2c7bb6;'>**Recruitment signal:**</span> ",
           "Tighter labor markets mean SHRS programs should emphasize strong ",
           "employment outcomes and competitive wages in recruitment materials\n"))
```

---

# 7 — Stored Outputs

```{r store}
lf_t33_2024_raw       <- raw
lf_t33_2024_total     <- total
lf_t33_2024_gender    <- gender
lf_t33_2024_age       <- if(exists("age")) age else NULL
lf_t33_2024_race      <- if(exists("race")) race else NULL
lf_t33_2024_benchmarks <- list(
  lfpr_current = lfpr_current, lfpr_projected = lfpr_projected,
  lfpr_change_pp = lfpr_change, yr3 = YR3, yr4 = YR4
)
```

```{r catalog, results='asis'}
cat("| Variable | Description |\n|---|---|\n")
cat(paste0("| `lf_t33_2024_raw` | Full T3.3 data (",nrow(raw)," rows) |\n"))
cat("| `lf_t33_2024_total` | Total LFPR row |\n")
cat("| `lf_t33_2024_gender` | Gender breakdown |\n")
cat("| `lf_t33_2024_age` | Age group rates |\n")
cat("| `lf_t33_2024_benchmarks` | Key LFPR benchmarks (list) |\n")
```

**Source:** BLS Table 3.3, 2024 vintage. Projection: 2024–2034.
