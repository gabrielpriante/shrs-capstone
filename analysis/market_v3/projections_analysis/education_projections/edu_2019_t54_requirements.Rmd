---
title: "SHRS Education Analysis — 2019 Entry Requirements & Training (Table 5.4)"
author: "SHRS MQE Capstone Team"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, message=FALSE, warning=FALSE, fig.width=10, fig.height=6)
```

```{r packages}
library(tidyverse); library(scales); library(knitr); library(kableExtra)
```

# 0 — Configuration

```{r config}
VINTAGE <- 2019
CSV_PATH <- file.path(path.expand("~"), "Documents", "SHRS_Analysis",
                       "market_analysis", "v3data", "projections_csv",
                       "education_csv", as.character(VINTAGE),
                       paste0("education_", VINTAGE, " - Table 5.4.csv"))

soc_xwalk <- tribble(
  ~shrs_program, ~shrs_dept, ~soc_code,
  "SLP","CSD","29-1127", "AuD","CSD","29-1181", "HIM","HIM","29-9021",
  "OTD","RST","29-1122", "DPT","RST","29-1123", "PAS","PAS","29-1071",
  "AT","SMN","29-9091",  "DN","SMN","29-1031",  "SS","SMN","29-1128")
target_socs <- soc_xwalk$soc_code
signal_colors <- c("Green"="#27ae60","Yellow"="#f39c12","Red"="#e74c3c")
```

# 1 — Load & Clean

```{r load}
raw <- read_csv(CSV_PATH, show_col_types=FALSE)
names(raw)[1:5] <- c("occ_title","soc_code","entry_education","work_experience","ojt_required")
if (ncol(raw)>=6) raw <- raw |> select(1:5)
raw <- raw |> mutate(soc_code=str_trim(soc_code),
                      occ_title=str_remove_all(occ_title,"\\(\\d+\\)|\\[\\d+\\]") |> str_trim())

shrs_t54 <- raw |> filter(soc_code %in% target_socs) |> left_join(soc_xwalk, by="soc_code")
```

```{r dq, results='asis'}
cat(paste0("**Vintage:** ",VINTAGE," | **Programs:** ",nrow(shrs_t54)," of 9\n\n"))
missing <- setdiff(target_socs, shrs_t54$soc_code)
if (length(missing)>0) cat(paste0("> **Missing:** ",
  paste(soc_xwalk|>filter(soc_code%in%missing)|>pull(shrs_program),collapse=", "),"\n\n"))
```

---

# 2 — Entry Requirements

```{r entry-table}
shrs_t54 |>
  select(Program=shrs_program, Dept=shrs_dept, `Entry Education`=entry_education,
         `Work Experience`=work_experience, `OJT Required`=ojt_required) |>
  arrange(factor(Program, levels=soc_xwalk$shrs_program)) |>
  kable(caption=paste0("BLS Entry Requirements (",VINTAGE,")")) |>
  kable_styling(bootstrap_options=c("striped","hover"), full_width=FALSE)
```

---

# 3 — Training Burden & Scorecard

```{r burden-scorecard}
shrs_t54 <- shrs_t54 |>
  mutate(
    edu_tier = case_when(entry_education=="Doctoral or professional degree"~4,
                          entry_education=="Master's degree"~3,
                          entry_education=="Bachelor's degree"~2,
                          entry_education=="Associate's degree"~1, TRUE~0),
    tier_label = case_when(edu_tier==4~"Doctoral",edu_tier==3~"Master's",
                            edu_tier==2~"Bachelor's",edu_tier==1~"Associate's",TRUE~"Below"),
    edu_years = case_when(entry_education=="Doctoral or professional degree"~21,
                           entry_education=="Master's degree"~18,
                           entry_education=="Bachelor's degree"~16,
                           entry_education=="Associate's degree"~14, TRUE~12),
    edu_burden = case_when(entry_education=="Doctoral or professional degree"~3,
                            entry_education=="Master's degree"~2,
                            entry_education=="Bachelor's degree"~1,
                            entry_education=="Associate's degree"~0, TRUE~0),
    exp_burden = case_when(work_experience=="5 years or more"~3,
                            work_experience=="Less than 5 years"~2,
                            work_experience=="None"~0, TRUE~0),
    ojt_burden = case_when(str_detect(ojt_required,regex("long-term",ignore_case=TRUE))~3,
                            str_detect(ojt_required,regex("moderate",ignore_case=TRUE))~2,
                            str_detect(ojt_required,regex("internship|residency",ignore_case=TRUE))~2,
                            str_detect(ojt_required,regex("short-term",ignore_case=TRUE))~1,
                            ojt_required=="None"~0, TRUE~0),
    total_burden = edu_burden + exp_burden + ojt_burden,
    d1_training_simple = round((1 - total_burden/9)*100, 1),
    d2_exp_accessible  = round((1 - exp_burden/3)*100, 1),
    composite = round((d1_training_simple + d2_exp_accessible)/2, 1),
    signal = case_when(composite>=70~"Green", composite>=50~"Yellow", TRUE~"Red"))

shrs_t54 |>
  select(Program=shrs_program, `Entry Ed`=entry_education,
         Edu=edu_burden, Exp=exp_burden, OJT=ojt_burden, `Total`=total_burden,
         `Train Simple`=d1_training_simple, `Exp Access`=d2_exp_accessible,
         Composite=composite, Signal=signal) |>
  arrange(factor(Program, levels=soc_xwalk$shrs_program)) |>
  kable(digits=1, caption=paste0("Burden & Scorecard (",VINTAGE,")")) |>
  kable_styling(bootstrap_options=c("striped","hover"), full_width=FALSE)
```

```{r burden-chart, fig.height=5}
shrs_t54 |>
  select(shrs_program, edu_burden, exp_burden, ojt_burden) |>
  pivot_longer(-shrs_program, names_to="component", values_to="score") |>
  mutate(component=case_when(component=="edu_burden"~"Education",
                              component=="exp_burden"~"Experience",
                              component=="ojt_burden"~"OJT")) |>
  ggplot(aes(x=factor(shrs_program, levels=intersect(soc_xwalk$shrs_program,shrs_t54$shrs_program)),
             y=score, fill=component)) +
  geom_col(width=0.6) +
  scale_fill_manual(values=c("Education"="#2c7bb6","Experience"="#fdae61","OJT"="#d7191c")) +
  labs(title=paste0("Training Burden (",VINTAGE,")"), x=NULL, y="Score") +
  theme_minimal(base_size=13) +
  theme(axis.text.x=element_text(angle=30,hjust=1), legend.position="bottom")
```

```{r sc-rank, fig.height=5}
shrs_t54 |>
  ggplot(aes(x=reorder(shrs_program,composite), y=composite, fill=signal)) +
  geom_col(width=0.6) + geom_text(aes(label=composite), hjust=-0.1, size=4) +
  coord_flip() + scale_fill_manual(values=signal_colors) +
  scale_y_continuous(limits=c(0,110)) +
  labs(title=paste0("Entry Composite (",VINTAGE,")"), x=NULL, y="Score") +
  theme_minimal(base_size=13) + theme(legend.position="bottom")
```

---

# 4 — Stored Outputs

```{r store}
t54_2019_data <- shrs_t54
t54_2019_scorecard <- shrs_t54 |>
  select(shrs_program, shrs_dept, soc_code, entry_education, work_experience,
         ojt_required, edu_tier, tier_label, edu_years, edu_burden, exp_burden,
         ojt_burden, total_burden, d1_training_simple, d2_exp_accessible, composite, signal)
```

```{r catalog, results='asis'}
cat("| Variable | Dims |\n|---|---|\n")
cat(paste0("| `t54_2019_data` | ",nrow(t54_2019_data),"x",ncol(t54_2019_data)," |\n"))
cat(paste0("| `t54_2019_scorecard` | ",nrow(t54_2019_scorecard),"x",ncol(t54_2019_scorecard)," |\n"))
```

**Source:** BLS Table 5.4, 2019 vintage. HIM missing. AT = Bachelor's (pre-reclassification).
